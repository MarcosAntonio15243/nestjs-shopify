# 🛍️ Shopify Orders Webhook Integration (NestJS + Drizzle + Docker)

This project is an API developed using **NestJS** with **Drizzle ORM** and **PostgreSQL**, designed to integrate with the **Shopify API**. It handles OAuth authentication for Shopify stores and receives **order creation webhooks (orders/create)**.

## Table of Contents

- [Technologies Used](#technologies-used)
- [Prerequisites](#prerequisites)
- [Setting Up a Public Domain (ngrok or alternative)](#setting-up-a-public-domain-ngrok-or-alternative)
- [Initial Setup on Shopify](#initial-setup-on-shopify)
- [Project Configuration](#project-configuration)
- [Running the Project](#running-the-project)
  - [Option 1: Using Docker](#option-1-using-docker)
  - [Option 2: Using Node.js/NPM (Local Development)](#option-2-using-nodejsnpm-local-development)
- [API Endpoints](#api-endpoints)
- [Testing the Integration](#testing-the-integration)
- [Supported Webhooks](#supported-webhooks)
- [(Optional) Viewing Saved Data in the Database](#optional-viewing-saved-data-in-the-database)
- [Project Structure](#project-structure)

## Technologies Used

- [NestJS](https://nestjs.com/) - A progressive Node.js framework for building efficient, reliable, and scalable server-side applications.
- [Drizzle ORM](https://orm.drizzle.team/) - Type-safe operations on the database.
- [Shopify API](https://shopify.dev/docs/api) - Shopify’s REST/GraphQL APIs used for OAuth authentication and order webhooks.
- [Ngrok](https://ngrok.com/) - Tunnel to expose your local API to the internet.
- [PostgreSQL](https://www.postgresql.org/) - Relational database for data persistence.
- [Docker](https://www.docker.com/) - Containerization for the application and database.
- [Zod](https://zod.dev/) - TypeScript-first schema and data validation.

## Prerequisites

Before getting started, make sure you have:

- [Node.js (>= 18.x)](https://nodejs.org)
- [Docker and Docker Compose](https://docs.docker.com/compose/install/)
- [Ngrok](https://ngrok.com/) (or an alternative like [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/)) to expose your local API
- A developer account on [Shopify](https://partners.shopify.com/)

## Setting Up a Public Domain (Ngrok or Alternative)

To receive Shopify webhooks and OAuth callbacks, your local API must be accessible from the internet. Ngrok is recommended for this.

1. Install [Ngrok](https://ngrok.com/) and run:

    ```bash
    ngrok http 3000
    ```

    > Replace `3000` with the port your NestJS app uses if different (e.g., `ngrok http 3333`).
   
2. Copy the HTTPS URL generated by ngrok (e.g., `https://abcd1234.ngrok.io`).

3. Update your project configuration:
   
    - In your `.env` file, set:

      ```env
      HOST=https://abcd1234.ngrok.io
      ```
  
4. You will use this URL in your Shopify app configuration in the next step.

## Initial Setup on Shopify

Now that you have a public domain, follow these steps to create and configure your Shopify app:

1. Go to [Shopify Partners](https://partners.shopify.com/) and log in or create an account.

2. Create a **custom app**:
    - Navigate to **Apps** → **Create app** → **Custom App**.
    - Choose a name, for example: `Webhook Orders App`.

3. Generate credentials:
    - Copy the **API Key** (Client ID) and **API Secret** and save them in your `.env` file (see [Project Configuration](#project-configuration)).

4. Configure your app URLs using the ngrok URL:

    - Set **App URL** to:

      ```bash
      https://abcd1234.ngrok.io/auth/shopify
      ```

    - Set **Redirect URL** to:

      ```bash
      https://abcd1234.ngrok.io/auth/shopify/redirect
      ```

5. Create a **development store** to test your app:
    - In the Shopify Partners dashboard, go to **Stores** → **Add store** → **Create development store**.
    - Enter a store name and confirm.

6. Install your custom app in the development store:
    - In your Shopify Partners dashboard, go to **Apps** and open your custom app.
    - Then go to **Distribution** and select **Custom domain**.
    - Enter your test store domain (e.g., `store-name.myshopify.com`).
    - Use the installation link generated by Shopify to install the app into your test store. This link typically looks like:
    
    ```bash
    https://{store-name}.myshopify.com/admin/oauth/authorize?client_id={API_KEY}&scope={SCOPES}&redirect_uri={REDIRECT_URI}
    ```

    - Open this link in your browser and confirm the app installation in your test store.

> **Tip**: You can always update the ngrok URL in Shopify and your `.env` file if you restart ngrok and get a new domain.

## Project Configuration

1. Create a `.env` file based on `.env.example`:

```env
# Server Configuration
PORT=3000 # HTTP server port

# Database Connection
DATABASE_HOST=db                  # e.g., database service name in docker-compose.yml
DATABASE_USER=postgres            # your DB username
DATABASE_PASSWORD=postgres        # your DB password
DATABASE_PORT=5432                # default PostgreSQL port
DATABASE_NAME=nestshop            # your DB name
# Format: postgresql://USER:PASSWORD@DATABASE_HOST:PORT/DATABASE_NAME?schema=public
DATABASE_URL=postgresql://postgres:postgres@db:5432/nestshop?schema=public

# Shopify App Credentials
SHOPIFY_API_KEY=your_api_key_here
SHOPIFY_API_SECRET=your_api_secret_here
SHOPIFY_SCOPES=read_products,write_orders
SHOPIFY_API_VERSION=2025-07 # Shopify API version

# Public App URL (Ngrok or Custom Domain)
HOST=https://your-ngrok-subdomain.ngrok-free.app
```

2. (Optional) If you want to view the saved data using [Drizzle Studio](https://orm.drizzle.team/drizzle-studio/overview), create a `.env.studio` file:

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/nestshop?schema=public
```

> **Note**: The URL is similar to the one in `.env`, but the `DATABASE_HOST` changes from `db` to `localhost` so Drizzle Studio can connect locally.

## Running the Project

You can run the project in two ways: via Docker (recommended for isolated environments) or locally with Node.js and Docker only for the database.

### Option 1: Using Docker

> Recommended for isolated development environments.

From the project root, run:

```bash
docker-compose up --build
```

This will build and start both the API and the PostgreSQL database.

To stop containers later:

```bash
docker-compose down
```

### Option 2: Using Node.js/NPM (Local Development)

1. Install dependencies:

  ```bash
  npm install
  ```

2. Start the PostgreSQL database container:

  ```bash
  docker-compose up -d db
  ```

  > Make sure port 5432 is free on your machine to avoid conflicts.
  >  **Note**: `db` is the service name defined for the database in the `docker-compose.yml` file. The default port for the `db` service is `5432`, as it uses PostgreSQL.

3. Update your `.env` and `.env.studio` to use `localhost` in `DATABASE_URL`:

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/nestshop?schema=public
```

4. Apply database migrations locally:
  
```bash
npm run db:migrate
```

5. Run the API server in development mode:

```bash
npm run start:dev
```

## API Endpoints

You can explore and test the available API endpoints using the documentation below.

The default base URL is usually one of the following, depending on your setup:

- Local: `http://localhost:3000`
- Ngrok: `https://your-ngrok-subdomain.ngrok.io`
- Custom domain: `https://your-custom-domain.com`

Available endpoints:

| Method   | Endpoint                   | Description                                                |
|----------|----------------------------|------------------------------------------------------------|
| `GET`    | `/health`                  | Verifies if the API is running properly.                   |
| `GET`    | `/auth/shopify`            | Starts the Shopify OAuth authentication flow.              |
| `GET`    | `/auth/shopify/redirect`   | Handles the OAuth redirect after authentication.           |
| `POST`   | `/webhooks/orders/create`  | Receives Shopify order creation webhooks.                  |
| `GET`    | `/orders`                  | Retrieves all saved orders with details.                   |
| `GET`    | `/orders/:shopDomain`      | Retrieves all saved orders from a specific Shopify domain. |

## Testing the Integration

1. Access your test store admin panel:

```bash
https://admin.shopify.com/store/your-test-store-name
```

2. Create a product and place an order.

3. Shopify will send order creation webhooks automatically to your public API URL:

```bash
POST https://abcd1234.ngrok.io/webhooks/orders/create
```

4. To verify if the webhook was received:

    - Check your API logs for webhook request entries.
    - Use the `GET /orders` or `GET /orders/shopDomain` endpoints to confirm the order data is saved.

## Supported Webhooks

Currently, this project only listens to:

- `orders/create`: Receives information about new orders placed in the store.

## (Optional) Viewing Saved Data in the Database

If you created a `.env.studio` file and configured the `DATABASE_URL` for **Drizzle Studio**, you can view the saved data by running the following command from the project root in a new terminal:

```bash
npm run db:studio
```

Then open Drizzle Studio at https://local.drizzle.studio in your browser.

## Project Structure

```bash
src/
├── auth/                 # OAuth authentication module with Shopify
│   └── dto/              # Data Transfer Objects used by the auth methods
│   ...
├── common/               # Shared code
│   ├── dto/              # Reusable DTOs shared across modules (e.g., Shopify Webhooks)
│   ├── interceptors/     # Reusable interceptors (e.g., HMAC validation)
│   └── mapper/           # Functions to transform and map external data (e.g., Shopify → DB format)
├── drizzle/              # Drizzle ORM configuration
│   ├── migrations/       # Database migration files
│   ├── schema/           # Database table schemas
│   └── types/            # TypeScript types related to the database
│   ...
├── env/                  # Environment variable validation using zod
├── orders/               # View information about orders saved in the system
├── webhooks/             # Shopify webhooks receiving and handling module
├── app.module.ts
├── main.ts
.env
.env.studio
docker-compose.yml
Dockerfile
```

**Note**:

The core flow of the app mainly happens within the auth and webhooks modules, which handle authentication and webhook processing respectively.

## Author

Made by [Marcos Antonio](https://github.com/MarcosAntonio15243).

- 💻 Full Stack developer dedicated to building complete solutions by combining modern, functional user interfaces with robust back-end architectures.
- 🚀 Always open to feedback, collaboration, or ideas for improvement!
- 📫 Feel free to connect with me on [LinkedIn](https://www.linkedin.com/in/marcos-antonio-18059b234) or check out more of my projects here on GitHub.
